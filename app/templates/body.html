<!DOCTYPE html>
<html>

  <head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta name="description" content="A demo showcasing the integration of R Shiny with Tailwind CSS, demonstrating modern web development practices in R.">
    <title>{{ app_title }}</title>    
    
    {{ headContent() }}
    {{ import_www() }}

  </head>

  <!-- the user will see any hard-coded HTML below. you can use it to set up your logged-out UI -->
  <body style="background-color: #E3A4A5;">

    <!-- Firebase login UI -->
    {{ uiOutput("login") }}

    <!-- the "protected" output hides app content behind the authorization flow. -->
    {{ uiOutput("protected") }}

  </body>

    <!-- firebase/identity provider initialization and persistence -->
    <!-- https://firebase.google.com/docs/web/alt-setup -->
    <!-- latest version requires importing as a module, this adds some complexity
           in particular, you need to add vars to window to make them available as click actions and to other templates.
           for example, instead of `var = "value"` you would use `window.var = "value"`
     -->
    <script type="module">

      import { initializeApp } from 'https://www.gstatic.com/firebasejs/11.2.0/firebase-app.js'
      import { getAuth, browserLocalPersistence } from 'https://www.gstatic.com/firebasejs/11.2.0/firebase-auth.js'

      const config = {
        apiKey: "{{ firebase_config$apiKey }}",
        authDomain: "{{ firebase_config$authDomain }}",
      };

      window.app = initializeApp(config);
      window.auth = getAuth(app);
      window.user = null; // will need to persist this for the login template.

      auth.setPersistence(browserLocalPersistence)
        .then(() => {
          auth.onAuthStateChanged((iuser) => {
            if (iuser) {

                iuser.getIdToken().then(function (idToken) {
                  Shiny.setInputValue("user_login", [idToken, iuser]);
                  window.user = iuser;
                });

            } else {
              Shiny.setInputValue("user_logout", "logout");
          }})

        })

      Shiny.addCustomMessageHandler("user_alert", function (message) {
        alert(message)
        if(message == 'ReCAPTCHA failed.') {
          window.location.reload();
        }
      });

      Shiny.addCustomMessageHandler("show_mfa", function(message){
        window.show_mfa = true; 
      })

    </script>
  
</html>