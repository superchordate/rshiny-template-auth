<!-- Claude helped me build this! -->
<div id="login_template" class="w-full pt-12 flex justify-center"><div class="bg-white p-8 rounded-lg shadow-md w-96">
    <h2 class="text-2xl font-bold mb-6 text-center text-gray-800">Login</h2>
    
    <div>
        <!-- email / password inputs -->
        {{if(auth_methods$email) HTML('
            <div id="email_password_block" class="">
                <div class="mb-4">
                    <label class="block text-gray-700 text-sm font-bold mb-2" for="email">
                        Email
                    </label>
                    <input class="shadow appearance-none border rounded w-full py-2 px-3 text-gray-700 leading-tight focus:outline-none focus:shadow-outline" 
                        id="email" type="text" placeholder="your@email.com" required>
                </div>
                
                <div id="passwordblock" class="mb-6">
                    <label class="block text-gray-700 text-sm font-bold mb-2" for="password">
                        Password
                    </label>
                    <input class="shadow appearance-none border rounded w-full py-2 px-3 text-gray-700 mb-3 leading-tight focus:outline-none focus:shadow-outline" 
                        id="password" type="password" placeholder="*****************" required>
                </div>
                
                <button id="signin" class="cursor-pointer bg-blue-500 hover:bg-blue-700 text-white font-bold py-2 px-4 rounded focus:outline-none focus:shadow-outline w-full" 
                    onclick="loginWithEmailPassword()">
                    Sign In
                </button>
                    
                <button id="forgotPassword" class="hidden cursor-pointer bg-blue-500 hover:bg-blue-700 text-white font-bold py-2 px-4 rounded focus:outline-none focus:shadow-outline w-full" 
                    onclick="forgotPassword()">
                        Send Password Reset Email
                </button>
                                
                <button id="newUser" class="hidden cursor-pointer bg-blue-500 hover:bg-blue-700 text-white font-bold py-2 px-4 rounded focus:outline-none focus:shadow-outline w-full" 
                    onclick="registerNewUser()">
                        Register
                </button>

            </div>
        ')}}

        <!-- MFA -->
        {{if(auth_methods$mfa_sms) HTML('
            <div id="mfa_phone_block" class="hidden mb-4">
                <label class="block text-gray-700 text-sm font-bold mb-2" for="mfa_phone">
                    Phone Number
                </label>
                <input class="shadow appearance-none border rounded w-full py-2 px-3 text-gray-700 leading-tight focus:outline-none focus:shadow-outline" 
                    id="mfa_phone" type="text" placeholder="">
                <p class="text-sm italic mt-1 mb-8">Only used for Two-Factor Authentication</p>
                <button id="sendMfaCode" class="cursor-pointer bg-blue-500 hover:bg-blue-700 text-white font-bold py-2 px-4 rounded focus:outline-none focus:shadow-outline w-full" 
                    onclick="sendMfaCode()">
                    Send Code
                </button>
            </div>
            
            <div id="mfa_code_block" class="hidden mb-4">                
                <label class="text-gray-700 text-sm font-bold mb-2" for="mfa_code">
                    Verification Code
                </label>                
                <input class="shadow appearance-none border rounded w-full py-2 px-3 text-gray-700 leading-tight focus:outline-none focus:shadow-outline" 
                    id="mfa_code" type="text" placeholder="">
                <button id="submitMfaCode" class="mt-6 cursor-pointer bg-blue-500 hover:bg-blue-700 text-white font-bold py-2 px-4 rounded focus:outline-none focus:shadow-outline w-full" 
                    onclick="submitMfaCode()">
                    Submit
                </button>
            </div>
        ')}}
        
        <!-- log in with google  -->
        {{if(auth_methods$google) HTML('
        <div class="flex flex-col gap-4">
            <button type="button" id="loginWithGoogle"
                onclick="loginWithGoogle()"
                class="mt-4 cursor-pointer flex items-center justify-center gap-2 bg-white border border-gray-300 text-gray-700 font-bold py-2 px-4 rounded focus:outline-none focus:shadow-outline w-full hover:bg-gray-50">
                <img src="data:image/svg+xml;base64,PHN2ZyB4bWxucz0iaHR0cDovL3d3dy53My5vcmcvMjAwMC9zdmciIHdpZHRoPSIxOCIgaGVpZ2h0PSIxOCIgdmlld0JveD0iMCAwIDQ4IDQ4Ij48cGF0aCBmaWxsPSIjRkZDMTA3IiBkPSJNNDMuNjExLDIwLjA4M0g0MlYyMEgyNHY4aDExLjMwM2MtMS42NDksNC42NTctNi4wOCw4LTExLjMwMyw4Yy02LjYyNywwLTEyLTUuMzczLTEyLTEyYzAtNi42MjcsNS4zNzMtMTIsMTItMTJjMy4wNTksMCw1Ljg0MiwxLjE1NCw3Ljk2MSwzLjAzOWw1LjY1Ny01LjY1N0MzNC4wNDYsNi4wNTMsMjkuMjY4LDQsMjQsNEMxMi45NTUsNCw0LDEyLjk1NSw0LDI0YzAsMTEuMDQ1LDguOTU1LDIwLDIwLDIwYzExLjA0NSwwLDIwLTguOTU1LDIwLTIwQzQ0LDIyLjY1OSw0My44NjIsMjEuMzUsNDMuNjExLDIwLjA4M3oiPjwvcGF0aD48cGF0aCBmaWxsPSIjRkYzRDAwIiBkPSJNNi4zMDYsMTQuNjkxbDYuNTcxLDQuODE5QzE0LjY1NSwxNS4xMDgsMTguOTYxLDEyLDI0LDEyYzMuMDU5LDAsNS44NDIsMS4xNTQsNy45NjEsMy4wMzlsNS42NTctNS42NTdDMzQuMDQ2LDYuMDUzLDI5LjI2OCw0LDI0LDRDMTYuMzE4LDQsOS42NTYsOC4zMzcsNi4zMDYsMTQuNjkxeiI+PC9wYXRoPjxwYXRoIGZpbGw9IiM0Q0FGNTAiIGQ9Ik0yNCw0NGM1LjE2NiwwLDkuODYtMS45NzcsMTMuNDA5LTUuMTkybC02LjE5LTUuMjM4QzI5LjIxMSwzNS4wOTEsMjYuNzE1LDM2LDI0LDM2Yy01LjIwMiwwLTkuNjE5LTMuMzE3LTExLjI4My03Ljk0NmwtNi41MjIsNS4wMjVDOS41MDUsMzkuNTU2LDE2LjIyNyw0NCwyNCw0NHoiPjwvcGF0aD48cGF0aCBmaWxsPSIjMTk3NkQyIiBkPSJNNDMuNjExLDIwLjA4M0g0MlYyMEgyNHY4aDExLjMwM2MtMC43OTIsMi4yMzctMi4yMzEsNC4xNjYtNC4wODcsNS41NzFjMC4wMDEtMC4wMDEsMC4wMDItMC4wMDEsMC4wMDMtMC4wMDJsNi4xOSw1LjIzOEMzNi45NzEsMzkuMjA1LDQ0LDM0LDQ0LDI0QzQ0LDIyLjY1OSw0My44NjIsMjEuMzUsNDMuNjExLDIwLjA4M3oiPjwvcGF0aD48L3N2Zz4=" 
                    alt="Google logo" 
                    class="w-6 h-6">
                Login with Google
            </button>
        </div>
        ')}}

        <!-- forgot password/register new user -->
        {{if(auth_methods$email) HTML(paste0(c('
            <div id="forgot_register_block" class="mt-4 space-4">
                <button class="cursor-pointer text-gray-600 hover:text-gray-800 text-sm mb-2 underline" onclick="forgotPasswordShow()" id="forgotPassword_button">
                    Forgot password?
                </button>
                <br/>', if(auth_methods$allow_register_new_user){ '
                <button class="cursor-pointer text-gray-600 hover:text-gray-800 text-sm underline" onclick="registerNewUserShow()" id="newUser_button">
                    Register as a new user.
                </button>' }, '
            </div>
        ')))}}
</div>

    <div id="recaptcha-container"></div>

</div></div>

<script type="module">

    import { 
        getAuth, RecaptchaVerifier, multiFactor, PhoneAuthProvider, signInWithEmailAndPassword ,
        PhoneMultiFactorGenerator, getMultiFactorResolver, GoogleAuthProvider, signInWithPopup, sendPasswordResetEmail
    } from 'https://www.gstatic.com/firebasejs/11.2.0/firebase-auth.js'

    window.recaptchaVerifier = new RecaptchaVerifier(auth, 'recaptcha-container', {'size': 'invisible'});

    window.mfaRegisterShow = function(){
        document.getElementById('email_password_block').classList.toggle('hidden');
        document.getElementById('mfa_phone_block').classList.toggle('hidden');
        document.getElementById('signin').classList.toggle('hidden');
        document.getElementById('loginWithGoogle').classList.toggle('hidden');
        document.getElementById('forgot_register_block').classList.toggle('hidden');
    }
    if(window.show_mfa) mfaRegisterShow();

    window.sendMfaCode = async () => {

        // if there is a resolver, we don't have a user yet. 
        if(window.resolver){

            const phoneInfoOptions = {
                multiFactorHint: window.resolver.hints[0], // there is only one MFA right now. see https://firebase.google.com/docs/auth/web/multi-factor#web_26 to select from multiple.
                session: window.resolver.session
            };

            // Send SMS verification code.
            const phoneAuthProvider = new PhoneAuthProvider(auth);
            phoneAuthProvider.verifyPhoneNumber(phoneInfoOptions, recaptchaVerifier)
                .then(function (verificationId) {
                    window.mfa_verificationId = verificationId;
                    document.getElementById('mfa_code_block').classList.toggle('hidden');
                    document.getElementById('mfa_phone_block').classList.toggle('hidden');
                });

        } else {
        
            multiFactor(user).getSession().then(function (multiFactorSession) {
                
                const phoneInfoOptions = {
                    phoneNumber: document.getElementById('mfa_phone').value,
                    session: multiFactorSession
                };

                const phoneAuthProvider = new PhoneAuthProvider(window.auth);

                phoneAuthProvider.verifyPhoneNumber(phoneInfoOptions, window.recaptchaVerifier)

                    .then(function (verificationId) {
                        window.mfa_verificationId = verificationId;
                        document.getElementById('mfa_code_block').classList.toggle('hidden');
                        document.getElementById('mfa_phone_block').classList.toggle('hidden');
                    })
                    .catch(error => {
                        recaptchaVerifier.clear();
                        console.log('sendMfaCode', error);
                        if (error.code === "auth/requires-recent-login") {
                            alert("reCAPTCHA needs a recent authentication. Please reauthenticate.");
                            auth.signOut();
                            window.location.reload();
                        } else if(error.code === 'auth/second-factor-already-in-use'){
                            // this means we accidentally followed the enroll flow. 
                            // log out and try again. 
                            alert("This account already has multi-factor authentication enabled. Something went wrong, sorry! Please try again.");
                            auth.signOut();
                            window.location.reload();
                        } else {
                            console.log(error);
                        }
                    });
            });

        }

    }

    // https://firebase.google.com/docs/auth/web/multi-factor#web_26
    window.submitMfaCode = async () => {

        const mfa_code = document.getElementById('mfa_code').value;
        const cred = PhoneAuthProvider.credential(window.mfa_verificationId, mfa_code);
        const multiFactorAssertion = PhoneMultiFactorGenerator.assertion(cred);

        // if there is a resolver, resolve it.
        if(window.resolver){

            // Complete sign-in. This will also trigger the Auth state listeners.
            window.resolver.resolveSignIn(multiFactorAssertion)
                .then(function (userCredential) {
                    // userCredential will also contain the user, additionalUserInfo, optional
                    // credential (null for email/password) associated with the first factor sign-in.
                    // For example, if the user signed in with Google as a first factor,
                    // userCredential.additionalUserInfo will contain data related to Google
                    // provider that the user signed in with.
                    // - user.credential contains the Google OAuth credential.
                    // - user.credential.accessToken contains the Google OAuth access token.
                    // - user.credential.idToken contains the Google OAuth ID token.
                    // Shiny.setInputValue('mfa_verification', userCredential);
                });

        // otherwise, this is a new enrollment.
        } else {

            return multiFactor(user).enroll(multiFactorAssertion).then(() => {
                Shiny.setInputValue('mfa_verification', {mfa_verificationId: window.mfa_verificationId, mfa_code: mfa_code})
            }).catch((error) => {
                
                if(error.code === 'auth/second-factor-already-in-use'){
                    // this means we accidentally followed the enroll flow. 
                    // log out and try again. 
                    alert("This account already has multi-factor authentication enabled. Something went wrong, sorry! Please try again.");
                    auth.signOut();
                    window.recaptchaVerifier.clear();
                    window.location.reload();
                } else {
                    console.log(error);
                    alert("Verification failed. Please try again.")
                }
            });

        }

    }

    window.loginWithEmailPassword = function () {

        const email = document.getElementById('email').value;
        const password = document.getElementById('password').value;
  
        signInWithEmailAndPassword(auth, email, password)
            .catch((error) => {
                if (error.code == 'auth/multi-factor-auth-required') {

                    // The user is a multi-factor user. Second factor challenge is required.
                    window.resolver = getMultiFactorResolver(auth, error);

                    // show the phone input.
                    document.getElementById('email_password_block').classList.toggle('hidden');
                    document.getElementById('mfa_phone_block').classList.toggle('hidden');
                    document.getElementById('signin').classList.toggle('hidden');
                    document.getElementById('loginWithGoogle').classList.toggle('hidden');
                    document.getElementById('forgot_register_block').classList.toggle('hidden');

                } else if(error.code == 'auth/invalid-credential') {
                    alert("Invalid email or password. Please try again.");

                } else {
                    console.log(error)
        }});

    }

    window.loginWithGoogle = function() {        
        signInWithPopup(auth, new GoogleAuthProvider())
        .catch(error => {
            if (error.code == 'auth/multi-factor-auth-required') {
                    
                // The user is a multi-factor user. Second factor challenge is required.
                window.resolver = getMultiFactorResolver(auth, error);

                // show the phone input.
                document.getElementById('email_password_block').classList.toggle('hidden');
                document.getElementById('mfa_phone_block').classList.toggle('hidden');
                document.getElementById('signin').classList.toggle('hidden');
                document.getElementById('loginWithGoogle').classList.toggle('hidden');
                document.getElementById('forgot_register_block').classList.toggle('hidden');

            } else if(error.code == 'auth/admin-restricted-operation') {
                alert("Not a user. Please contact Support.");
                
            } else {
                console.log(error)
            }
        });
    }

    window.forgotPasswordShow = function(){
        document.getElementById('signin').classList.toggle('hidden');
        document.getElementById('passwordblock').classList.toggle('hidden');
        document.getElementById('loginWithGoogle').classList.toggle('hidden');
        document.getElementById('forgotPassword').classList.toggle('hidden');
        document.getElementById('forgotPassword_button').classList.toggle('hidden');
        // document.getElementById('newUser_button').classList.toggle('hidden');
    }

    window.forgotPassword = function() {

        const email = document.getElementById('email').value;      
        
        window.recaptchaVerifier.verify()
            .then(token => {
                Shiny.setInputValue(
                    'forgot_password', 
                    [token, document.getElementById('email').value]
                );
            })
            .catch(error => {
                alert('Failed reCAPTCHA');
                console.log(error);
            });

    }

    window.registerNewUserShow = function(){
        document.getElementById('signin').classList.toggle('hidden');
        document.getElementById('loginWithGoogle').classList.toggle('hidden');
        document.getElementById('forgotPassword_button').classList.toggle('hidden');
        document.getElementById('newUser_button').classList.toggle('hidden');
        document.getElementById('newUser').classList.toggle('hidden');
    }
    window.registerNewUser = function() {

        // new user flow:
        //   validate username/password.
        //   check recaptcha and get token.
        //   send username, password, and recaptcha token to server for verification and account creation.

        if(!document.getElementById('email').value){
            alert("Email is required.");
            return;
        }

        if(!document.getElementById('password').value){
            alert("Password is required.");
            return;
        }
        
        window.recaptchaVerifier.verify()
            .then(token => {
                Shiny.setInputValue(
                    'new_user_register', 
                    [token, document.getElementById('email').value, document.getElementById('password').value]
                );
            })
            .catch(error => {
                alert('Failed reCAPTCHA');
                console.log(error);
            });
    }

</script>